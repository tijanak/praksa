<!DOCTYPE html>
<html>
  <head>
    <style>
      .toolbox {
        margin-bottom: 5px;
      }
      .image-container {
        position: relative;
        width: 1024px;
        height: 1024px;
      }
      .canvas-mask {
        position: absolute;
        top: 0;
        left: 0;
      }
      .image-map {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div id="imageContainer" class="image-container">
      <img id="imageMap" class="image-map" src="256x256_x4.png" />
      <canvas id="canvasMask" class="canvas-mask" />
    </div>
    <script>
      let modelScale = { height: 1024, width: 1024, samScale: 1 };
      let panelSize = { width: 40, height: 30 };

      let panels = [];

      const canvas = document.getElementById("canvasMask");
      const ctx = canvas.getContext("2d");
      canvas.width = modelScale.width;
      canvas.height = modelScale.height;
      function drawParallelThroughPoint(point) {
        ctx.fillStyle = "#0077CC66";
        ctx.strokeStyle = "#0077CC";
        ctx.beginPath();
        ctx.moveTo(0, point.y);
        ctx.lineTo(modelScale.width, point.y);
        ctx.stroke();
      }
      let testPoly = [
        {
          x: 598,
          y: 169,
        },
        {
          x: 664,
          y: 244,
        },
        {
          x: 754,
          y: 234,
        },
        {
          x: 662,
          y: 121,
        },
      ];
      let test2 = [
        {
          x: 206,
          y: 210,
        },
        {
          x: 226,
          y: 272,
        },
        {
          x: 319,
          y: 262,
        },
        {
          x: 234,
          y: 204,
        },
      ];
      let p2 = [
        { x: 0, y: 0 },
        { x: modelScale.width, y: 0 },
        { x: modelScale.width, y: modelScale.height },
        { x: 0, y: modelScale.height },
      ];
      let test3 = [
        {
          x: 702,
          y: 679,
        },
        {
          x: 641,
          y: 760,
        },
        {
          x: 639,
          y: 871,
        },
        {
          x: 753,
          y: 967,
        },
        {
          x: 846,
          y: 889,
        },
        {
          x: 876,
          y: 777,
        },
      ];
      let random = [
        {
          x: 230,
          y: 241,
        },
        {
          x: 341,
          y: 205,
        },
        {
          x: 452,
          y: 280,
        },
        {
          x: 346,
          y: 292,
        },
        {
          x: 342,
          y: 363,
        },
        {
          x: 258,
          y: 321,
        },
      ];
      drawPolygon(random);
      function calculatePanels(roofVertexes, baseLine) {}
      function getMidPoint(polygon) {
        let midPoint = { x: 0, y: 0 };
        for (let i = 0; i < polygon.length; i++) {
          midPoint.x += polygon[i].x;
          midPoint.y += polygon[i].y;
        }
        midPoint.x /= polygon.length;
        midPoint.y /= polygon.length;
        return midPoint;
      }
      function radians(degrees) {
        return (degrees * Math.PI) / 180;
      }
      function rotatePolygon(polygon, degree) {
        degree = radians(degree);
        //console.log(polygon);
        for (let i = 0; i < polygon.length; i++) {
          let vertexX = polygon[i].x,
            vertexY = polygon[i].y;
          polygon[i].x =
            vertexX * Math.cos(degree) - vertexY * Math.sin(degree);
          polygon[i].y =
            vertexX * Math.sin(degree) + vertexY * Math.cos(degree);
        }
        //console.log(polygon);
      }
      function translatePolygon(polygon, x, y) {
        for (let i = 0; i < polygon.length; i++) {
          polygon[i].x += x;
          polygon[i].y += y;
        }
      }
      function getSlope(v1, v2) {
        var kol = v1.x - v2.x;
        if (kol == null) return 0;
        return (Math.atan((v1.y - v2.y) / (v1.x - v2.x)) * 180) / Math.PI;
      }
      function findIntersection(v1, v2, y) {
        var kol = v1.x - v2.x;
        if (kol == null) return null;
        var m = (v1.y - v2.y) / kol;
        var c = v1.y - m * v1.x;
        if (m == 0) return null;
        var x = (y - c) / m;
        if (x > Math.max(v1.x, v2.x) || x < Math.min(v1.x, v2.x)) return null;
        return { x, y };
      }
      function drawDot(dot) {
        ctx.fillStyle = "#FF0000";
        var dotSize = 4;
        ctx.fillRect(
          dot.x - dotSize / 2,
          dot.y - dotSize / 2,
          dotSize,
          dotSize
        );
      }
      function drawHelperLine(v1, v2) {
        ctx.strokeStyle = "#CCCCCC";
        ctx.moveTo(v1.x, v1.y);
        ctx.lineTo(v2.x, v2.y);
        ctx.stroke();
      }
      function pairwise(verteces) {
        return verteces.map((v, i) => {
          if (i < verteces.length - 1) {
            return [v, verteces[i + 1]];
          } else return [v, verteces[0]];
        });
      }
      function drawPolygon(polygon) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let midPoint = getMidPoint(polygon);
        let ind1 = 4,
          ind2 = 5;
        let point = { x: polygon[ind1].x, y: polygon[ind1].y };
        let point2 = { x: polygon[ind2].x, y: polygon[ind2].y };
        let deg = -getSlope(point2, point);
        console.log(deg);

        translatePolygon(polygon, -midPoint.x, -midPoint.y);
        rotatePolygon(polygon, deg);

        translatePolygon(polygon, midPoint.x, midPoint.y);
        let ys = polygon.map((v) => v.y);
        console.log(ys);
        let maxY = Math.max(...ys);
        let minY = Math.min(...ys);
        //translatePolygon(polygon, 0, deltaY);
        ctx.translate(midPoint.x, midPoint.y);
        ctx.rotate(-radians(deg));
        ctx.translate(-midPoint.x, -midPoint.y);
        // ctx.translate(0, -deltaY);

        ctx.fillStyle = "#0077CC66";
        ctx.strokeStyle = "#0077CC";
        let path = new Path2D();
        path.moveTo(polygon[0].x, polygon[0].y);
        for (let i = 1; i < polygon.length; i++) {
          path.lineTo(polygon[i].x, polygon[i].y);
        }
        path.lineTo(polygon[0].x, polygon[0].y);

        ctx.fill(path);
        ctx.stroke(path);
        panels.push(path);
        // console.log(pairwise(polygon));
        let lines = pairwise(polygon);
        let intersections = [];
        for (let h = minY; h < polygon[ind1].y; h += panelSize.height) {
          //drawParallelThroughPoint({ x: polygon[ind1].x, y: h });
          console.log(h);
          let points = [];
          lines.forEach((v) => {
            let intersetion = findIntersection(v[0], v[1], h);
            //console.log(intersetion);
            if (intersetion) {
              points.push(intersetion);
            }
          });
          intersections.push(points);
        }
        for (let h = polygon[ind1].y; h <= maxY; h += panelSize.height) {
          //drawParallelThroughPoint({ x: polygon[ind1].x, y: h });
          console.log(h);
          let points = [];
          lines.forEach((v) => {
            let intersetion = findIntersection(v[0], v[1], h);
            //console.log(intersetion);
            if (intersetion) {
              points.push(intersetion);
            }
          });
          intersections.push(points);
        }
        //console.log(polygon[ind1], polygon[ind2], intersections);
        //intersections = intersections.sort((a, b) => a.y - b.y);
        console.log(intersections);
        for (let i = 0; i < intersections.length; i++) {
          for (let j = 0; j < intersections[i].length - 1; j++) {
            drawDot(intersections[i][j]);
            drawDot(intersections[i][j + 1]);
            //console.log(intersections[i][j], intersections[i][j + 1]);
            drawHelperLine(intersections[i][j], intersections[i][j + 1]);
          }
        }
        ctx.fillStyle = "#FF77CC66";
        ctx.strokeStyle = "#FF77CC";
        canvas.addEventListener("click", (e) => {
          console.log(e.offsetX, e.offsetY);
          panels.forEach((panel, index) => {
            if (ctx.isPointInPath(panel, e.offsetX, e.offsetY)) {
              console.log("yuh", index);
            }
          });
        });
      }
    </script>
  </body>
</html>
